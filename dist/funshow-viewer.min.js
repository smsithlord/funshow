class FunShow extends FunShowEventEmitter{constructor({slideshow:slideshow=null,mediaLibraryItems:mediaLibraryItems=null,enableUI:enableUI=false,allowWorkingPath:allowWorkingPath=false}={}){super();this.enableUI=enableUI;this.slideshow=slideshow;this.mediaLibraryItems=mediaLibraryItems;this.allowWorkingPath=allowWorkingPath;if(this.mediaLibraryItems&&!this.slideshow){const funShowItems=[];const hasChildSlides=folderId=>Object.values(this.mediaLibraryItems).some((item=>item.parent===folderId&&(item.type==="image"||item.type==="video")));const addFolderAndFiles=folderId=>{const folder=this.mediaLibraryItems[folderId];if(hasChildSlides(folderId)){funShowItems.push({title:folder.name,type:"category"});for(const itemId in this.mediaLibraryItems){const item=this.mediaLibraryItems[itemId];if(item.parent===folderId&&(item.type==="image"||item.type==="video")){funShowItems.push({file:!item.file||typeof item.file!="string"||!item.file.indexOf("blob:")?URL.createObjectURL(item.file):item.file,title:item.name,type:item.type,handle:item.file,directoryHandle:item.directory})}}}};for(const itemId in this.mediaLibraryItems){const item=this.mediaLibraryItems[itemId];if((item.type==="image"||item.type==="video")&&!item.parent){funShowItems.push({file:!item.file||typeof item.file!="string"||!item.file.indexOf("blob:")?URL.createObjectURL(item.file):item.file,title:item.name,type:item.type})}}for(const itemId in this.mediaLibraryItems){const item=this.mediaLibraryItems[itemId];if(item.type==="folder"&&!item.parent){addFolderAndFiles(itemId)}}this.slideshow={config:{},slides:funShowItems}}if(!this.slideshow.slides&&this.slideshow.items){this.slideshow.slides=this.slideshow.items;delete this.slideshow.items}const defaultSlideshow=window.funShowEnvironment.generateDefaultSlideshow();if(mediaLibraryItems){const originalSlides=this.slideshow.slides;this.slideshow=window.funShowEnvironment.mergeSlideshow(defaultSlideshow,{config:this.slideshow.config,slides:[]},false);this.slideshow.slides=originalSlides}else{this.slideshow=window.funShowEnvironment.mergeSlideshow(defaultSlideshow,this.slideshow,false)}if(!this.slideshow.items&&this.slideshow.slides){this.slideshow.items=this.slideshow.slides;delete this.slideshow.slides}if(this.slideshow?.config?.cloudinaryTransforms){window.funShowEnvironment.setApplyCloudinaryTransforms(true)}else{window.funShowEnvironment.setApplyCloudinaryTransforms(false)}if(mediaLibraryItems){if(this.slideshow.items.filter((item=>item.type!="category")).length<=1){this.slideshow.config.autoPlay=false}}this.lastUsedPath="";this.updateLastUsedPath(this.slideshow.config,this.slideshow.items);this.cssString="";this.injectCSSVariables();this.injectGoogleFonts();this.createContainer();this.createModules();this.injectCSS();this.initEventListeners();this.emit("initialize");this.startSimulationLoop()}updateLastUsedPath(config){let path=config.workingDirectory||config.contentPath||"";if(!this.allowWorkingPath){path=config.contentPath||""}path=path.replace(/\\/g,"/");if(path&&!path.endsWith("/")){path+="/"}this.lastUsedPath=path}destroy(){this.emit("destroy");this.stopSimulationLoop();this.removeEventListeners();if(this.stage){this.stage.destroy()}if(this.playlistPanel){this.playlistPanel.destroy()}if(this.toolbarPanel){this.toolbarPanel.destroy()}if(this.container&&this.container.parentNode){this.container.parentNode.removeChild(this.container)}this.removeInjectedCSS();this.removeGoogleFonts();this.slideshow=null;this.container=null;this.stage=null;this.playlistPanel=null;this.toolbarPanel=null}injectCSSVariables(){const adjustBrightness=(color,amount)=>"#"+color.replace(/^#/,"").replace(/../g,(color=>("0"+Math.min(255,Math.max(0,parseInt(color,16)+amount)).toString(16)).substr(-2)));const addOpacity=(color,opacity)=>{const hexOpacity=Math.round(opacity*255).toString(16).padStart(2,"0");return`${color}${hexOpacity}`};const colorSchema=[{name:"primary-color",value:this.slideshow.config.primaryColor||"#ffffff"},{name:"secondary-color",value:this.slideshow.config.secondaryColor||"#000000"},{name:"primary-bgcolor",value:this.slideshow.config.primaryBgColor||"#000000"},{name:"secondary-bgcolor",value:this.slideshow.config.secondaryBgColor||"#ffffff"}];const baseVariationSchema=[{suffix:"",modifier:color=>color},{suffix:"-highlight",modifier:color=>adjustBrightness(color,40)},{suffix:"-lowlight",modifier:color=>adjustBrightness(color,-40)}];const opacityVariationSchema=[{suffix:"",modifier:color=>color},{suffix:"-lowopacity",modifier:color=>addOpacity(color,.25)},{suffix:"-midopacity",modifier:color=>addOpacity(color,.5)},{suffix:"-highopacity",modifier:color=>addOpacity(color,.75)}];let cssVariables="";colorSchema.forEach((color=>{baseVariationSchema.forEach((baseVariation=>{const baseColor=baseVariation.modifier(color.value);opacityVariationSchema.forEach((opacityVariation=>{const finalColor=opacityVariation.modifier(baseColor);const suffix=baseVariation.suffix+opacityVariation.suffix;cssVariables+=`--${color.name}${suffix}: ${finalColor};\n`}))}))}));cssVariables+=`\n            --primary-font-family: ${this.slideshow.config.primaryFontFamily||"Arial, sans-serif"};\n            --secondary-font-family: ${this.slideshow.config.secondaryFontFamily||"Arial, sans-serif"};\n        `;this.cssString+=`\n            :root {\n                ${cssVariables}\n            }\n        `}injectGoogleFonts(){const standardFonts=["Arial","Helvetica","Times New Roman","Courier","Verdana"];if(this.slideshow.config.primaryFontFamily!==""&&standardFonts.indexOf(this.slideshow.config.primaryFontFamily)<0){const primaryFontUrl=`https://fonts.googleapis.com/css2?family=${this.slideshow.config.primaryFontFamily}&display=swap`;const primaryFontLink=document.createElement("link");primaryFontLink.href=primaryFontUrl;primaryFontLink.rel="stylesheet";document.head.appendChild(primaryFontLink)}if(this.slideshow.config.secondaryFontFamily!==""&&standardFonts.indexOf(this.slideshow.config.secondaryFontFamily)<0){const secondaryFontUrl=`https://fonts.googleapis.com/css2?family=${this.slideshow.config.secondaryFontFamily}&display=swap`;const secondaryFontLink=document.createElement("link");secondaryFontLink.href=secondaryFontUrl;secondaryFontLink.rel="stylesheet";document.head.appendChild(secondaryFontLink)}}createContainer(){this.container=document.createElement("div");this.container.classList.add("funshow-container");document.body.appendChild(this.container)}createModules(){this.stage=new FunShowStage(this);this.playlistPanel=new FunShowStagePanelPlaylist(this);if(this.enableUI){this.toolbarPanel=new FunShowStagePanelToolbar(this)}}injectCSS(){const style=document.createElement("style");style.textContent=this.cssString;style.setAttribute("data-funshow-styles","");document.head.appendChild(style)}initEventListeners(){this.wheelEventHandler=e=>{if(e.deltaY<0){this.emit("input:left")}else if(e.deltaY>0){this.emit("input:right")}};document.body.addEventListener("wheel",this.wheelEventHandler)}startSimulationLoop(){let lastTimestamp=performance.now();const self=this;function update(){const now=performance.now();const dt=(now-lastTimestamp)/1e3;lastTimestamp=now;self.emit("update",dt);self.animationFrameId=requestAnimationFrame(update)}this.animationFrameId=requestAnimationFrame(update)}stopSimulationLoop(){if(this.animationFrameId){cancelAnimationFrame(this.animationFrameId);this.animationFrameId=null}}removeEventListeners(){document.body.removeEventListener("wheel",this.wheelEventHandler)}removeInjectedCSS(){const styleElement=document.head.querySelector("style[data-funshow-styles]");if(styleElement){document.head.removeChild(styleElement)}}removeGoogleFonts(){const fontLinks=document.head.querySelectorAll('link[href^="https://fonts.googleapis.com/css2"]');fontLinks.forEach((link=>{document.head.removeChild(link)}))}}class FunShowSlide extends FunShowEventEmitter{constructor(funShow,item,container){super();this.funShow=funShow;this.item=item;this.container=container;this.mediaAsBackground=funShow.slideshow.config.mediaAsBackground;this.transitionTimeRemaining=-1;this.mediaObjectFit=this.item.config?.hasOwnProperty("mediaObjectFit")?this.item.config.mediaObjectFit:funShow.slideshow.config.slideMediaObjectFit;this.defaultScale=this.item.config?.hasOwnProperty("defaultScale")?this.item.config.defaultScale:funShow.slideshow.config.slideDefaultScale;this.styleIn=this.item.config?.hasOwnProperty("styleIn")?this.item.config.styleIn:funShow.slideshow.config.slideStyleIn;this.styleOut=this.item.config?.hasOwnProperty("styleOut")?this.item.config.styleOut:funShow.slideshow.config.slideStyleOut;this.styleActive=this.item.config?.hasOwnProperty("styleActive")?this.item.config.styleActive:funShow.slideshow.config.slideStyleActive;if(this.styleIn===""||this.styleOut===""){const numStyleInOut=7;const randomStyleType=Math.floor(Math.random()*(numStyleInOut+1));this.styleIn=this.styleIn===""?randomStyleType:this.styleIn;this.styleOut=this.styleOut===""?randomStyleType:this.styleOut}if(this.styleActive===""){const numStyleActive=8;const randomStyleActiveType=Math.floor(Math.random()*(numStyleActive+1));console.log("rando active style type",randomStyleActiveType);this.styleActive=randomStyleActiveType}this.spamProtection=funShow.slideshow.config.spamProtection;this.spamProtectionTimeRemaining=this.spamProtection;this.transitionDuration=funShow.slideshow.config.transitionDuration;this.transitionEntranceTime=funShow.slideshow.config.transitionEntranceTime;this.transitionExitTime=funShow.slideshow.config.transitionExitTime;this.fullyActiveTimestamp=-1;this.isLoaded=false;this.totalElapsed=0;this.displayElapsed=0;this.displayDuration=this.item.config?.hasOwnProperty("displayDuration")?this.item.config.displayDuration:funShow.slideshow.config.slideDisplayDuration;this.videoControls=this.item.config?.hasOwnProperty("videoControls")?this.item.config.videoControls:funShow.slideshow.config.slideVideoControls;this.videoMuted=this.item.config?.hasOwnProperty("videoMuted")?this.item.config.videoMuted:funShow.slideshow.config.slideVideoMuted;this.videoAutoplay=this.item.config?.hasOwnProperty("videoAutoplay")?this.item.config.videoAutoplay:funShow.slideshow.config.slideVideoAutoplay;this.videoLoop=this.item.config?.hasOwnProperty("videoLoop")?this.item.config.videoLoop:funShow.slideshow.config.slideVideoLoop;this.isDeferredActive=false;this.isActive=false;this.isLoaded=false;this.isDirectionNext=true;this.initEventListeners();this.loadingTimeout=null;this.loadingIndicator=null;this.removeLoadingIndicatorTimeout=null;if(!FunShowSlide.cssInjected){this.injectCSS();FunShowSlide.cssInjected=true}}static cssInjected=false;injectCSS(){const css=`\n            .funshow-slide {\n                position: absolute;\n                width: 100%;\n                height: 100%;\n                opacity: 0;\n                transition: all ${this.transitionDuration}s ease;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-sizing: border-box;\n                color: var(--primary-color);\n                fill: var(--primary-color);\n            }\n            .funshow-html {\n                color: var(--secondary-color);\n                width: 100%;\n                height: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-sizing: border-box;\n            }\n            .funshow-image, .funshow-video {\n                width: 100%;\n                height: 100%;\n            }\n            .funshow-slide-active {\n                z-index: 1;\n                opacity: 1;\n            }\n\n            .funshow-slide-content {\n                overflow: hidden;\n                position: relative;\n                width: 100%;\n                height: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                box-sizing: border-box;\n                font-family: var(--secondary-font-family);\n            }\n\n            .funshow-slide-active-complete {\n                transform: scale(1);\n            }\n\n\n            @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n\n            .funshow-loading-indicator {\n                pointer-events: none;\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n                align-items: center;\n                color: var(--secondary-color);\n                font-family: Arial, sans-serif;\n                z-index: 10;\n                opacity: 0;\n                transition: opacity 0.3s ease-in-out;\n                padding: 20px;\n                box-sizing: border-box;\n                text-align: center;\n            }\n\n            .funshow-loading-indicator.show {\n                opacity: 1;\n            }\n\n            .funshow-loading-spinner {\n                width: 50px;\n                height: 50px;\n                border: 5px solid #f3f3f3;\n                border-top: 5px solid #3498db;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n                margin-bottom: 20px;\n            }\n\n            .funshow-loading-text {\n                font-size: 18px;\n                margin-bottom: 10px;\n            }\n\n            .funshow-loading-details {\n                font-size: 14px;\n                max-width: 80%;\n                margin: 20px auto 0;\n                display: inline-block;\n                text-align: center;\n            }\n\n            .funshow-loading-details p {\n                margin: 5px 0;\n            }\n\n\n\n            /* type0: Drift */\n            .funshow-slide-active-complete.funshow-slide-active-type0 {\n            }\n\n            /* type1: Drift Zoom-In */\n            .funshow-slide-active-complete.funshow-slide-active-type1 {\n                transform: scale(1.2);\n            }\n\n            /* type2: Drift Zoom-Out */\n            .funshow-slide-active-complete.funshow-slide-active-type2 {\n                transform: scale(0.8);\n            }\n\n            /* type3: Zoom-In Low*/\n            .funshow-slide-active-complete.funshow-slide-active-type3 {\n                transform: scale(1.2);\n            }\n\n            /* type4: Zoom-In Mid */\n            .funshow-slide-active-complete.funshow-slide-active-type4 {\n                transform: scale(1.5);\n            }\n\n            /* type5: Zoom-In Max */\n            .funshow-slide-active-complete.funshow-slide-active-type5 {\n                transform: scale(2);\n            }\n\n            /* type6: Zoom-Out Low*/\n            .funshow-slide-active-complete.funshow-slide-active-type6 {\n                transform: scale(0.8);\n            }\n\n            /* type7: Zoom-Out Mid */\n            .funshow-slide-active-complete.funshow-slide-active-type7 {\n                transform: scale(0.5);\n            }\n\n            /* type8: Zoom-Out Max */\n            .funshow-slide-active-complete.funshow-slide-active-type8 {\n                transform: scale(0.25);\n            }\n\n\n            /* type0: bubble-in */\n            .funshow-slide-transition-in-next.funshow-slide-transition-type0-in {\n                opacity: 0;\n                transform: scale(0.5);\n            }\n            .funshow-slide-transition-out-next.funshow-slide-transition-type0-out {\n                opacity: 0;\n                transform: scale(1.5);\n            }\n            .funshow-slide-transition-in-prev.funshow-slide-transition-type0-in {\n                opacity: 0;\n                transform: scale(0.5);\n            }\n            .funshow-slide-transition-out-prev.funshow-slide-transition-type0-out {\n                opacity: 0;\n                transform: scale(1.5);\n            }\n\n            /* type1: bubble-out */\n            .funshow-slide-transition-in-next.funshow-slide-transition-type1-in {\n                opacity: 0;\n                transform: scale(1.5);\n            }\n            .funshow-slide-transition-out-next.funshow-slide-transition-type1-out {\n                opacity: 0;\n                transform: scale(0.5);\n            }\n            .funshow-slide-transition-in-prev.funshow-slide-transition-type1-in {\n                opacity: 0;\n                transform: scale(1.5);\n            }\n            .funshow-slide-transition-out-prev.funshow-slide-transition-type1-out {\n                opacity: 0;\n                transform: scale(0.5);\n            }\n\n            /* type2: swipe-up */\n            .funshow-slide-transition-in-next.funshow-slide-transition-type2-in {\n                opacity: 0;\n                transform: translateY(100%);\n            }\n            .funshow-slide-transition-out-next.funshow-slide-transition-type2-out {\n                opacity: 0;\n                transform: translateY(-100%);\n            }\n            .funshow-slide-transition-in-prev.funshow-slide-transition-type2-in {\n                opacity: 0;\n                transform: translateY(-100%);\n            }\n            .funshow-slide-transition-out-prev.funshow-slide-transition-type2-out {\n                opacity: 0;\n                transform: translateY(100%);\n            }\n\n            /* type3: swipe-down */\n            .funshow-slide-transition-in-next.funshow-slide-transition-type3-in {\n                opacity: 0;\n                transform: translateY(-100%);\n            }\n            .funshow-slide-transition-out-next.funshow-slide-transition-type3-out {\n                opacity: 0;\n                transform: translateY(100%);\n            }\n            .funshow-slide-transition-in-prev.funshow-slide-transition-type3-in {\n                opacity: 0;\n                transform: translateY(100%);\n            }\n            .funshow-slide-transition-out-prev.funshow-slide-transition-type3-out {\n                opacity: 0;\n                transform: translateY(-100%);\n            }\n\n            /* type4: swipe-left */\n            .funshow-slide-transition-in-next.funshow-slide-transition-type4-in {\n                opacity: 0;\n                transform: translateX(100%);\n            }\n            .funshow-slide-transition-out-next.funshow-slide-transition-type4-out {\n                opacity: 0;\n                transform: translateX(-100%);\n            }\n            .funshow-slide-transition-in-prev.funshow-slide-transition-type4-in {\n                opacity: 0;\n                transform: translateX(-100%);\n            }\n            .funshow-slide-transition-out-prev.funshow-slide-transition-type4-out {\n                opacity: 0;\n                transform: translateX(100%);\n            }\n\n            /* type5: swipe-right */\n            .funshow-slide-transition-in-next.funshow-slide-transition-type5-in {\n                opacity: 0;\n                transform: translateX(-100%);\n            }\n            .funshow-slide-transition-out-next.funshow-slide-transition-type5-out {\n                opacity: 0;\n                transform: translateX(100%);\n            }\n            .funshow-slide-transition-in-prev.funshow-slide-transition-type5-in {\n                opacity: 0;\n                transform: translateX(100%);\n            }\n            .funshow-slide-transition-out-prev.funshow-slide-transition-type5-out {\n                opacity: 0;\n                transform: translateX(-100%);\n            }\n\n            /* type6: toss-left  */\n            .funshow-slide-transition-in-next.funshow-slide-transition-type6-in {\n                opacity: 0;\n                transform: translateX(60%) scale(0.25) rotate(-0.15turn);\n            }\n            .funshow-slide-transition-out-next.funshow-slide-transition-type6-out {\n                opacity: 0;\n                transform: translateX(-60%) scale(0.25) rotate(0.15turn);\n            }\n            .funshow-slide-transition-in-prev.funshow-slide-transition-type6-in {\n                opacity: 0;\n                transform: translateX(-60%) scale(0.25) rotate(0.15turn);\n            }\n            .funshow-slide-transition-out-prev.funshow-slide-transition-type6-out {\n                opacity: 0;\n                transform: translateX(60%) scale(0.25) rotate(-0.15turn);\n            }\n\n            /* type7: toss-right  */\n            .funshow-slide-transition-in-next.funshow-slide-transition-type7-in {\n                opacity: 0;\n                transform: translateX(-60%) scale(0.25) rotate(0.15turn);\n            }\n            .funshow-slide-transition-out-next.funshow-slide-transition-type7-out {\n                opacity: 0;\n                transform: translateX(60%) scale(0.25) rotate(-0.15turn);\n            }\n            .funshow-slide-transition-in-prev.funshow-slide-transition-type7-in {\n                opacity: 0;\n                transform: translateX(60%) scale(0.25) rotate(-0.15turn);\n            }\n            .funshow-slide-transition-out-prev.funshow-slide-transition-type7-out {\n                opacity: 0;\n                transform: translateX(-60%) scale(0.25) rotate(0.15turn);\n            }\n        `;const style=document.createElement("style");style.textContent=css;document.head.appendChild(style)}initEventListeners(){this.on("activate",this.activate,this);this.on("deactivate",this.deactivate,this);this.funShow.on("update",this.updateTransition,this)}createLoadingIndicator(errorMessage=null){if(!this.loadingIndicator){this.loadingIndicator=document.createElement("div");this.loadingIndicator.startTimestamp=this.totalElapsed;this.loadingIndicator.className="funshow-loading-indicator";const spinner=document.createElement("div");spinner.className="funshow-loading-spinner";const loadingText=document.createElement("div");loadingText.className="funshow-loading-text";loadingText.textContent=errorMessage||"Loading...";const loadingDetails=document.createElement("div");loadingDetails.className="funshow-loading-details";loadingDetails.innerHTML=this.getLoadingDetails();this.loadingIndicator.appendChild(spinner);this.loadingIndicator.appendChild(loadingText);this.loadingIndicator.appendChild(loadingDetails);document.body.appendChild(this.loadingIndicator);this.loadingIndicator.offsetHeight;this.loadingIndicator.classList.add("show")}}getLoadingDetails(){let details="";if(this.item.type==="image"||this.item.type==="video"){details+=`Title: ${this.item.title}<br />`;details+=`File: ${this.item.file.split("/").pop()}<br />`;details+=`Type: ${this.item.type}<br />`;const mediaUrl=window.funShowEnvironment.prepareMediaSrc(this.item,this.funShow.lastUsedPath);const hostname=new URL(mediaUrl).hostname;details+=`Host: ${hostname}<br/>`}return details}updateLoadingIndicator(){if(this.loadingIndicator){const mediaElem=this.item.type==="image"?this.slideDiv.querySelector("img"):this.slideDiv.querySelector("video");const mediaUrl=window.funShowEnvironment.prepareMediaSrc(this.item,this.funShow.lastUsedPath);const hostname=new URL(mediaUrl).hostname;const width=this.item.type==="image"?mediaElem.naturalWidth:mediaElem.videoWidth;const height=this.item.type==="image"?mediaElem.naturalHeight:mediaElem.videoHeight;let details=`\n                Title: ${this.item.title}<br />\n                File: ${this.item.file.split("/").pop()}<br/>\n                Type: ${this.item.type}<br />\n                Host: ${hostname}<br/>\n                Dimensions: ${width}x${height}<br/>\n            `;if(this.item.type==="video"){const videoDuration=mediaElem.duration.toFixed(2)+" seconds";const buffered=mediaElem.buffered.length>0?`${mediaElem.buffered.start(0).toFixed(2)} - ${mediaElem.buffered.end(0).toFixed(2)} seconds`:"Not buffered";details+=`\n                    Duration: ${videoDuration}<br/>\n                    Buffered: ${buffered}<br/>\n                `}const loadingDetails=this.loadingIndicator.querySelector(".funshow-loading-details");if(loadingDetails){loadingDetails.innerHTML=details}}}slideLoaded(){this.isLoaded=true;this.clearLoadingTimeout();if(this.loadingIndicator){this.updateLoadingIndicator();this.loadingIndicator.classList.remove("show");this.removeLoadingIndicatorTimeout=setTimeout((()=>{this.removeLoadingIndicator()}),300)}if(this.transitionTimeRemaining<=0){this.transitionTimeRemaining=0;this.slideDiv.classList.remove("funshow-slide-transition-in","funshow-slide-transition-out","funshow-slide-transition-in-next","funshow-slide-transition-out-next","funshow-slide-transition-in-prev","funshow-slide-transition-out-prev");this.slideDiv.classList.add("funshow-slide-active")}this.emit("loaded")}createElement(){if(!this.slideDiv){this.slideDiv=document.createElement("div");this.slideDiv.classList.add("funshow-slide");this.slideContent=document.createElement("div");this.slideContent.classList.add("funshow-slide-content");this.slideDiv.appendChild(this.slideContent);this.slideDiv.classList.add(`funshow-slide-active-type${this.styleActive}`);this.slideDiv.classList.add(`funshow-slide-transition-type${this.styleIn}-in`);this.slideDiv.classList.add(`funshow-slide-transition-type${this.styleOut}-out`);let didSetBackground=false;if(this.item.type==="image"){const imageUrl=window.funShowEnvironment.prepareMediaSrc(this.item,this.funShow.lastUsedPath);this.mediaElement=document.createElement("img");this.mediaElement.src=imageUrl;this.mediaElement.classList.add("funshow-image");this.mediaElement.style.objectFit=this.item?.config?.hasOwnProperty("mediaObjectFit")?this.item?.config?.mediaObjectFit:this.mediaObjectFit;this.mediaElement.addEventListener("load",(()=>{this.slideLoaded()}));if(this.mediaAsBackground){document.body.originalBackground=document.body.style.background;document.body.style.background=`\n                        linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.95)),\n                        url("${imageUrl}") center/150% no-repeat\n                    `;document.body.style.backgroundSize="cover";didSetBackground=true}}else if(this.item.type==="video"){this.mediaElement=document.createElement("video");this.mediaElement.src=window.funShowEnvironment.prepareMediaSrc(this.item,this.funShow.lastUsedPath);this.mediaElement.classList.add("funshow-video");this.mediaElement.style.objectFit=this.item?.config?.hasOwnProperty("mediaObjectFit")?this.item?.config?.mediaObjectFit:this.mediaObjectFit;this.mediaElement.autoplay=this.videoAutoplay;this.mediaElement.controls=this.videoControls;this.mediaElement.loop=this.videoLoop;this.mediaElement.muted=this.videoMuted;this.mediaElement.setAttribute("playsinline","playsinline");this.mediaElement.addEventListener("canplaythrough",(()=>{this.slideLoaded()}))}else if(this.item.type==="html"){this.mediaElement=document.createElement("div");this.mediaElement.classList.add("funshow-html");this.mediaElement.innerHTML=this.item.file}this.slideContent.appendChild(this.mediaElement);this.container.appendChild(this.slideDiv);this.zoomPan=new FunShowZoomPan(this.slideDiv,this.slideContent,this.item?.config?.hasOwnProperty("defaultScale")?this.item?.config?.defaultScale:this.defaultScale);this.transitionTimeRemaining=this.transitionDuration*this.transitionExitTime;if(!didSetBackground&&document.body.originalBackground&&document.body.style.background!=document.body.originalBackground){document.body.style.background=document.body.originalBackground;delete document.body.originalBackground}if(this.item.type!=="image"&&this.item.type!=="video"){setTimeout((()=>{this.slideLoaded()}),1)}if(this.item.type==="image"||this.item.type==="video"){this.loadingTimeout=setTimeout((()=>{this.createLoadingIndicator()}),2e3)}}}clearLoadingTimeout(){if(this.loadingTimeout){clearTimeout(this.loadingTimeout);this.loadingTimeout=null}}clearRemoveLoadingIndicatorTimeout(){if(this.removeLoadingIndicatorTimeout){clearTimeout(this.removeLoadingIndicatorTimeout);this.removeLoadingIndicatorTimeout=null}}removeLoadingIndicator(){if(this.loadingIndicator&&this.loadingIndicator.parentNode){this.loadingIndicator.parentNode.removeChild(this.loadingIndicator)}const startTimestamp=this.loadingIndicator.startTimestamp;const nowTimestamp=this.totalElapsed;const totalWait=nowTimestamp-startTimestamp;window.funShowEnvironment.reportLoadingWaitFinished(totalWait);this.loadingIndicator=null}destroyElement(){this.clearLoadingTimeout();this.clearRemoveLoadingIndicatorTimeout();if(this.loadingIndicator){this.removeLoadingIndicator()}if(this.slideDiv){if(this.zoomPan){this.zoomPan.destroy();this.zoomPan=null}if(this.backgroundElement){this.backgroundElement.parentNode.removeChild(this.backgroundElement);this.backgroundElement=null}this.container.removeChild(this.slideDiv);this.slideDiv=null;this.mediaElement=null}}activate(direction,wasUserAction){this.isDirectionNext=!!direction&&direction>=0;this.spamProtectionTimeRemaining=this.spamProtection;this.isDeferredActive=true;this.isActive=false;this.isLoaded=this.item.type!=="image"&&this.item.type!=="video";this.displayElapsed=0}deactivate(direction,wasUserAction){if(this.loadingIndicator){this.loadingIndicator.classList.remove("show");this.removeLoadingIndicatorTimeout=setTimeout((()=>{this.removeLoadingIndicator()}),300)}this.isDirectionNext=!!direction&&direction>=0;this.transitionTimeRemaining=this.transitionDuration;this.isDeferredActive=false;this.isActive=false;this.isActiveComplete=false;if(this.slideDiv){this.slideDiv.classList.remove("funshow-slide-active","funshow-slide-active-complete");this.slideDiv.style.transition="";if((this.styleActive==="0"||this.styleActive==="1"||this.styleActive==="2")&&this.slideDiv.classList.contains(`funshow-slide-active-type${this.styleActive}`)){this.slideDiv.style.transform=""}this.slideDiv.offsetHeight;this.slideDiv.classList.add("funshow-slide-transition-out",this.isDirectionNext?"funshow-slide-transition-out-next":"funshow-slide-transition-out-prev")}if(this.fullyActiveTimestamp){}this.displayElapsed=0}activateDeferred(){this.createElement();if(this.slideDiv){this.slideDiv.classList.remove("funshow-slide-transition-out-next","funshow-slide-transition-out-prev");this.slideDiv.classList.add("funshow-slide-transition-in",this.isDirectionNext?"funshow-slide-transition-in-next":"funshow-slide-transition-in-prev");this.isDeferredActive=false;this.isActive=true}}updateTransition(dt){this.totalElapsed+=dt;if(this.spamProtectionTimeRemaining>0){this.spamProtectionTimeRemaining-=dt;if(this.spamProtectionTimeRemaining<=0){this.spamProtectionTimeRemaining=0;if(this.isDeferredActive){this.activateDeferred()}}}if(this.isActive&&this.isLoaded){this.displayElapsed+=dt;if(!this.isActiveComplete&&this.displayElapsed>=this.transitionDuration*this.transitionEntranceTime+this.transitionDuration*this.transitionExitTime&&this.slideDiv){this.isActiveComplete=true;this.emit("arriving");this.fullyActiveTimestamp=this.displayElapsed;this.slideDiv.classList.add("funshow-slide-active-complete");this.slideDiv.style.transition=`all ${this.transitionDuration}s ease, transform ${this.displayDuration*2}s ease-out`;const driftDirections=[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1}];if(this.styleActive!=="0"){driftDirections.push({x:0,y:0})}const randomDriftDirection=driftDirections[Math.floor(Math.random()*driftDirections.length)];if(this.styleActive==="0"){this.slideDiv.style.transform=`translate(${randomDriftDirection.x*8}%, ${randomDriftDirection.y*8}%)`}else if(this.styleActive==="1"){this.slideDiv.style.transform=`scale(1.2) translate(${randomDriftDirection.x*8}%, ${randomDriftDirection.y*8}%)`}else if(this.styleActive==="2"){this.slideDiv.style.transform=`scale(0.8) translate(${randomDriftDirection.x*8}%, ${randomDriftDirection.y*8}%)`}}}if(this.transitionTimeRemaining>0){this.transitionTimeRemaining-=dt;if(this.transitionTimeRemaining<=0){this.transitionTimeRemaining=-1;if(this.slideDiv&&!this.isActive){this.destroyElement()}else if(this.slideDiv){if(this.isLoaded){this.transitionTimeRemaining=0;this.slideDiv.classList.remove("funshow-slide-transition-in","funshow-slide-transition-out","funshow-slide-transition-in-next","funshow-slide-transition-out-next","funshow-slide-transition-in-prev","funshow-slide-transition-out-prev");this.slideDiv.classList.add("funshow-slide-active")}}}}}}class FunShowStage extends FunShowEventEmitter{constructor(funShow){super();this.funShow=funShow;this.stageTransparent=funShow.slideshow.config.stageTransparent;this.loop=funShow.slideshow.config.loop;this.currentIndex=0;this.slides=[];this.initEventListeners()}initEventListeners(){this.funShow.on("initialize",this.initialize,this);this.funShow.on("input:right",this.onInputNext,this);this.funShow.on("input:left",this.onInputPrevious,this)}initialize(){this.createContainer();this.createSlides();this.injectCSS();this.findFirstSlide()}createContainer(){this.container=document.createElement("div");this.container.classList.add("funshow-stage-container");document.body.appendChild(this.container);if(this.funShow.slideshow.config.stageBackgroundImage!=""){const imageUrl=window.funShowEnvironment.prepareMediaSrc({type:"image",file:this.funShow.slideshow.config.stageBackgroundImage},this.funShow.lastUsedPath);document.body.style.background=`url("${imageUrl}")`;document.body.style.backgroundSize="cover"}else if(!this.funShow.slideshow.config.stageTransparent){document.body.style.background="var(--secondary-bgcolor)"}}onSlideArriving(){this.emit("slide:arriving")}onSlideLoaded(){}createSlides(){this.funShow.slideshow.items.forEach((item=>{const slide=new FunShowSlide(this.funShow,item,this.container);slide.emit("initialize");slide.on("arriving",this.onSlideArriving,this);slide.on("loaded",this.onSlideLoaded,this);this.slides.push(slide)}))}injectCSS(){this.funShow.cssString+=`\n            .funshow-stage-container {\n                color: var(--secondary-color);\n                position: relative;\n                width: 100%;\n                height: 100vh;\n                overflow: hidden;\n                z-index: 1;\n            }\n        `}findFirstSlide(){while(this.currentIndex<this.slides.length&&(!this.slides[this.currentIndex].item.file||this.slides[this.currentIndex].item.type==="category")){this.currentIndex++}if(this.currentIndex>=this.slides.length){this.currentIndex=this.findNextValidSlide(-1,1)}if(!this.slides[this.currentIndex]||!this.slides[this.currentIndex].item.file||this.slides[this.currentIndex].item.type==="category"){this.currentIndex=0}}findNextValidSlide(startIndex,direction){let index=startIndex;const initialIndex=startIndex;do{index+=direction;if(this.loop){if(index>=this.slides.length){index=0}else if(index<0){index=this.slides.length-1}}else if(index<0||index>=this.slides.length){return startIndex}if(this.slides[index]&&this.slides[index].item.file&&this.slides[index].item.type!=="category"){return index}}while(index!==initialIndex);return startIndex}startSlideshow(){this.currentIndex=-1;if(this.funShow.slideshow.config.playlistStartShuffle){this.jumpToRandomSlide(false)}else{this.changeSlide(1)}this.emit("start");const helpInput=new FunShowHelpInput(window.funShowEnvironment.isMobile)}changeSlide(direction,wasUserAction){this.currentIndex=!!direction&&direction!=0?this.findNextValidSlide(this.currentIndex,direction):this.findNextValidSlide(this.currentIndex,1);if(this.slides.length===0){return}if(this.previousIndex!==undefined){this.slides[this.previousIndex].emit("deactivate",direction,wasUserAction)}this.slides[this.currentIndex].emit("activate",direction,wasUserAction);this.emit("change",{previousIndex:this.previousIndex,currentIndex:this.currentIndex,direction:direction,wasUserAction:!!wasUserAction});this.previousIndex=this.currentIndex}jumpToIndex(slideIndex){this.changeSlide(slideIndex-this.currentIndex,true)}jumpToRandomSlide(wasUserAction){if(this.slides.length<=1){return}let randomIndex;do{randomIndex=Math.floor(Math.random()*this.slides.length)}while(randomIndex===this.currentIndex||!this.slides[randomIndex].item.file);this.changeSlide(randomIndex-this.currentIndex,wasUserAction)}nextSlide(wasUserAction){if(this.funShow.playlistPanel?.isShuffle){this.jumpToRandomSlide(wasUserAction)}else{this.changeSlide(1,wasUserAction)}}previousSlide(wasUserAction){if(this.funShow.playlistPanel?.isShuffle){this.jumpToRandomSlide(wasUserAction)}else{this.changeSlide(-1,wasUserAction)}}onInputNext(){this.nextSlide(true)}onInputPrevious(){this.previousSlide(true)}destroy(){this.removeEventListeners();this.destroySlides();this.removeContainer();document.body.style.backgroundImage="";this.funShow=null;this.slides=null;this.container=null;this.emit("destroy")}removeEventListeners(){if(this.funShow){this.funShow.off("initialize",this.initialize,this);this.funShow.off("input:right",this.onInputNext,this);this.funShow.off("input:left",this.onInputPrevious,this)}}destroySlides(){if(this.slides){this.slides.forEach((slide=>{slide.off("arriving",this.onSlideArriving,this);slide.off("loaded",this.onSlideLoaded,this);if(typeof slide.destroy==="function"){slide.destroy()}}));this.slides=[]}}removeContainer(){if(this.container&&this.container.parentNode){this.container.parentNode.removeChild(this.container)}}}class FunShowStagePanelPlaylist extends FunShowEventEmitter{constructor(funShow){super();this.funShow=funShow;this.loop=this.funShow.slideshow.config.loop;this.isCollapsed=funShow.slideshow.config.playlistStartCollapsed;this.isShuffle=funShow.slideshow.config.playlistStartShuffle;this.isPlaying=false;this.autoMinimize=funShow.slideshow.config.playlistAutoMinimize;this.alwaysShowOnSlideChange=funShow.slideshow.config.playlistAlwaysShowOnSlideChange;this.pauseOnInteraction=funShow.slideshow.config.playlistPauseOnInteraction;this.slideDuration=funShow.slideshow.config.slideDisplayDuration*1e3;this.elaspedSinceLastInteraction=0;this.autoMinimizeDuration=funShow.slideshow.config.playlistAutoMinimizeDuration;this.toggleCollapsedState=this.toggleCollapsedState.bind(this);this.onPrevClick=this.onPrevClick.bind(this);this.toggleShuffleState=this.toggleShuffleState.bind(this);this.onPlayClick=this.onPlayClick.bind(this);this.onPauseClick=this.onPauseClick.bind(this);this.onNextClick=this.onNextClick.bind(this);this.userInteraction=this.userInteraction.bind(this);this.injectCSS();this.initEventListeners()}injectCSS(){const css=`\n            .funshow-playlist {\n                position: absolute;\n                top: 20px;\n                right: 20px;\n                background: var(--primary-bgcolor-highopacity);\n                color: var(--primary-color);\n                padding: 10px;\n                border-radius: 5px;\n                width: 300px;\n                font-family: var(--primary-font-family);\n                font-size: 14px;\n                z-index: 10;\n                transition: width 0.5s ease;\n                overflow-x: hidden;\n            }\n            .funshow-playlist-content {\n                width: 300px;\n            }\n            .funshow-playlist-minimized {\n                width: 24px;\n                opacity: 0.5;\n            }\n            .funshow-playlist-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                margin-bottom: 10px;\n            }\n            .funshow-playlist-header-info {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: center;\n                gap: 2px;\n                font-size: 12px;\n                line-height: 75%;\n            }\n            .funshow-playlist-icon {\n                width: 24px;\n                height: 24px;\n                cursor: pointer;\n                fill: var(--primary-color);\n            }\n            .funshow-playlist-controls {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 10px;\n            }\n            .funshow-playlist-controls svg {\n                width: 24px;\n                height: 24px;\n                fill: var(--primary-color);\n                cursor: pointer;\n            }\n            .funshow-playlist-info {\n                display: none;\n                flex-direction: column;\n                align-items: center;\n                text-align: center;\n                margin-bottom: 10px;\n            }\n            .funshow-playlist-info span {\n                margin-bottom: 5px;\n            }\n            .funshow-playlist-collapsed-info {\n                display: none;\n                font-size: 12px;\n                text-align: center;\n            }\n            .funshow-playlist-section-slide-info {\n                display: none;\n                flex-direction: column;\n                margin-bottom: 10px;\n                text-align: center;\n            }\n            .funshow-playlist-slides {\n                max-height: 50vh;\n                overflow-y: auto;\n                pointer-events: none;\n            }\n            .funshow-playlist-collapsed .funshow-playlist-slides {\n                display: none;\n            }\n            .funshow-playlist-slide {\n                padding: 5px;\n                cursor: pointer;\n                border-radius: 4px;\n                padding-left: 20px;\n                pointer-events: auto;\n            }\n            .funshow-playlist-slide.funshow-playlist-slide-active {\n                background: var(--primary-bgcolor-highlight-midopacity);\n                color: var(--primary-color-highlight);\n                font-weight: bold;\n            }\n            .funshow-playlist-slide.section {\n                font-weight: bold;\n                padding-left: 5px;\n                background: var(--primary-bgcolor-highlight);\n                color: var(--primary-color-highlight);\n            }\n            .funshow-playlist-slide.sticky-section {\n                position: -webkit-sticky;\n                position: sticky;\n                top: 0;\n                z-index: 5;\n            }\n            .funshow-playlist-slides::-webkit-scrollbar {\n                width: 10px;\n            }\n            .funshow-playlist-slides::-webkit-scrollbar-thumb {\n                background-color: var(--primary-bgcolor-highlight-midopacity);\n                border-radius: 4px;\n            }\n            .funshow-playlist-slides::-webkit-scrollbar-thumb:hover {\n                background-color: var(--primary-color-highopacity);\n            }\n            .funshow-playlist-slides::-webkit-scrollbar-track {\n                background-color: var(--primary-bgcolor-lowopacity);\n                border-radius: 4px;\n            }\n            .funshow-playlist-slides::-webkit-scrollbar-track:hover {\n                background-color: var(--primary-bgcolor-midopacity);\n            }\n            .funshow-playlist-collapsed .funshow-playlist-info {\n                display: flex;\n            }\n            .funshow-playlist-collapsed .funshow-playlist-collapsed-info {\n                display: block;\n            }\n            .funshow-playlist-collapsed .funshow-playlist-section-slide-info {\n                display: none;\n            }\n            .funshow-progress-bar {\n                width: 100%;\n                height: 4px;\n                background: var(--primary-color-lowopacity);\n                position: relative;\n                margin-bottom: 10px;\n                display: none;\n            }\n            .funshow-playlist-playing .funshow-progress-bar {\n                display: block;\n            }\n            .funshow-progress-bar-fill {\n                height: 100%;\n                background: var(--primary-color);\n                width: 0;\n                transition: width linear;\n            }\n            .funshow-playlist .funshow-play-icon,\n            .funshow-playlist .funshow-pause-icon {\n                display: none;\n            }\n            .funshow-playlist-playing .funshow-play-icon {\n                display: none;\n            }\n            .funshow-playlist-playing .funshow-pause-icon {\n                display: inline-block;\n            }\n            .funshow-playlist:not(.funshow-playlist-playing) .funshow-play-icon {\n                display: inline-block;\n            }\n            .funshow-shuffle-icon {\n                opacity: 0.5;\n            }\n            .funshow-shuffle-icon:hover {\n                opacity: 0.9;\n            }\n            .funshow-playlist-shuffle .funshow-shuffle-icon {\n                opacity: 1;\n            }\n            .funshow-playlist-minimized .funshow-playlist-hidden-if-minimized {\n                display: none;\n            }\n            .funshow-playlist-shuffle .funshow-prev-icon {\n                display: none;\n            }\n        `;const style=document.createElement("style");style.textContent=css;document.head.appendChild(style)}initEventListeners(){this.funShow.stage.on("change",this.updateActiveItem,this);this.funShow.stage.on("slide:arriving",this.onSlideArriving,this);this.funShow.on("initialize",this.initHTML,this);this.funShow.on("update",this.update,this)}initHTML(){const playlistHTML=`\n            <div class="funshow-playlist">\n                <div class="funshow-playlist-content">\n                    <div class="funshow-playlist-header">\n                        <svg class="funshow-playlist-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">\n                            <rect x="4" y="5" width="16" height="2"/>\n                            <rect x="4" y="11" width="16" height="2"/>\n                            <rect x="4" y="17" width="16" height="2"/>\n                        </svg>\n                        <div class="funshow-playlist-header-info funshow-playlist-hidden-if-minimized">\n                            <span class="funshow-section-count"></span>\n                            <span class="funshow-slide-count"></span>\n                        </div>\n                        <div class="funshow-playlist-controls funshow-playlist-hidden-if-minimized">\n                            <svg class="funshow-shuffle-icon" viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg">\n                                <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm0.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>\n                            </svg>\n                            <svg class="funshow-prev-icon" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>\n                            <svg class="funshow-play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>\n                            <svg class="funshow-pause-icon" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>\n                            <svg class="funshow-next-icon" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>\n                        </div>\n                    </div>\n                </div>\n                <div class="funshow-progress-bar">\n                    <div class="funshow-progress-bar-fill"></div>\n                </div>\n                <div class="funshow-playlist-content">\n                    <div class="funshow-playlist-collapsed-info funshow-playlist-hidden-if-minimized">\n                        <div class="funshow-section-info"></div>\n                        <div class="funshow-slide-info"></div>\n                    </div>\n                    <div class="funshow-playlist-section-slide-info funshow-playlist-hidden-if-minimized">\n                        <div class="funshow-current-section-info"></div>\n                        <div class="funshow-current-slide-info"></div>\n                    </div>\n                    <div class="funshow-playlist-slides funshow-playlist-hidden-if-minimized"></div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",playlistHTML);this.playlist=document.querySelector(".funshow-playlist");if(this.isCollapsed){this.playlist.classList.add("funshow-playlist-collapsed")}if(this.isShuffle){this.playlist.classList.add("funshow-playlist-shuffle")}this.title=this.playlist.querySelector(".funshow-playlist-header");this.headerInfo=this.playlist.querySelector(".funshow-playlist-header-info");this.sectionCount=this.playlist.querySelector(".funshow-section-count");this.slideCount=this.playlist.querySelector(".funshow-slide-count");this.infoContainer=this.playlist.querySelector(".funshow-playlist-section-slide-info");this.collapsedInfo=this.playlist.querySelector(".funshow-playlist-collapsed-info");this.sectionInfo=this.playlist.querySelector(".funshow-section-info");this.slideInfo=this.playlist.querySelector(".funshow-slide-info");this.currentSectionInfo=this.playlist.querySelector(".funshow-current-section-info");this.currentSlideInfo=this.playlist.querySelector(".funshow-current-slide-info");this.slidesContainer=this.playlist.querySelector(".funshow-playlist-slides");this.progressBar=this.playlist.querySelector(".funshow-progress-bar-fill");function disableUserScroll(element){element.addEventListener("wheel",preventDefault,{passive:false});element.addEventListener("touchmove",preventDefault,{passive:false});element.addEventListener("keydown",preventScrollKeys,{passive:false});function preventDefault(event){event.preventDefault()}function preventScrollKeys(event){const keys=[32,33,34,35,36,37,38,39,40];if(keys.includes(event.keyCode)){event.preventDefault()}}}disableUserScroll(this.slidesContainer);this.updateTitle();this.title.querySelector(".funshow-playlist-icon").addEventListener("click",(()=>{this.toggleCollapsedState()}));this.title.querySelector(".funshow-prev-icon").addEventListener("click",(()=>{if(this.isShuffle){this.funShow.stage.jumpToRandomSlide(true)}else{this.funShow.stage.changeSlide(-1,true)}}));this.title.querySelector(".funshow-shuffle-icon").addEventListener("click",(()=>{this.toggleShuffleState()}));this.title.querySelector(".funshow-play-icon").addEventListener("click",(()=>{this.isPlaying=true;this.startSlideshow();this.resetRemainingSlideTime()}));this.title.querySelector(".funshow-pause-icon").addEventListener("click",(()=>{this.isPlaying=false;this.pauseSlideshow()}));this.title.querySelector(".funshow-next-icon").addEventListener("click",(()=>{if(this.isShuffle){this.funShow.stage.jumpToRandomSlide(true)}else{this.funShow.stage.changeSlide(1,true)}}));this.funShow.stage.slides.forEach(((slide,index)=>{const div=document.createElement("div");div.textContent=slide.item.title;div.dataset.index=index;div.classList.add("funshow-playlist-slide");if(slide.item.type==="category"){div.classList.add("section")}div.addEventListener("click",(()=>{this.funShow.stage.jumpToIndex(index)}));this.slidesContainer.appendChild(div)}));if(this.autoMinimize){this.playlist.addEventListener("mousemove",this.userInteraction.bind(this));this.playlist.addEventListener("click",this.userInteraction.bind(this));this.playlist.addEventListener("keydown",this.userInteraction.bind(this))}if(this.funShow.slideshow?.config?.autoPlay){this.startSlideshow()}}destroy(){this.removeEventListeners();this.removeDOMElements();this.clearTimers();this.funShow=null;this.playlist=null;this.title=null;this.headerInfo=null;this.sectionCount=null;this.slideCount=null;this.infoContainer=null;this.collapsedInfo=null;this.sectionInfo=null;this.slideInfo=null;this.currentSectionInfo=null;this.currentSlideInfo=null;this.slidesContainer=null;this.progressBar=null;this.emit("destroy")}removeEventListeners(){if(this.funShow&&this.funShow.stage){this.funShow.stage.off("change",this.updateActiveItem,this);this.funShow.stage.off("slide:arriving",this.onSlideArriving,this)}if(this.funShow){this.funShow.off("initialize",this.initHTML,this);this.funShow.off("update",this.update,this)}if(this.playlist){const playlistIcon=this.playlist.querySelector(".funshow-playlist-icon");if(playlistIcon){playlistIcon.removeEventListener("click",this.toggleCollapsedState)}const prevIcon=this.playlist.querySelector(".funshow-prev-icon");if(prevIcon){prevIcon.removeEventListener("click",this.onPrevClick)}const shuffleIcon=this.playlist.querySelector(".funshow-shuffle-icon");if(shuffleIcon){shuffleIcon.removeEventListener("click",this.toggleShuffleState)}const playIcon=this.playlist.querySelector(".funshow-play-icon");if(playIcon){playIcon.removeEventListener("click",this.onPlayClick)}const pauseIcon=this.playlist.querySelector(".funshow-pause-icon");if(pauseIcon){pauseIcon.removeEventListener("click",this.onPauseClick)}const nextIcon=this.playlist.querySelector(".funshow-next-icon");if(nextIcon){nextIcon.removeEventListener("click",this.onNextClick)}if(this.autoMinimize){this.playlist.removeEventListener("mousemove",this.userInteraction);this.playlist.removeEventListener("click",this.userInteraction);this.playlist.removeEventListener("keydown",this.userInteraction)}}}removeDOMElements(){if(this.playlist&&this.playlist.parentNode){this.playlist.parentNode.removeChild(this.playlist)}}clearTimers(){}startSlideshow(){this.isPlaying=true;this.playlist.classList.add("funshow-playlist-playing");this.remainingSlideTime=Infinity;this.updateProgressBar()}pauseSlideshow(){this.isPlaying=false;this.playlist.classList.remove("funshow-playlist-playing");this.remainingSlideTime=0;this.progressBar.style.width="0%"}resetRemainingSlideTime(){this.remainingSlideTime=this.slideDuration;this.updateProgressBar()}update(dt){if(this.autoMinimize){if(this.elaspedSinceLastInteraction<this.autoMinimizeDuration){this.elaspedSinceLastInteraction+=dt;if(this.elaspedSinceLastInteraction>=this.autoMinimizeDuration){this.elaspedSinceLastInteraction=this.autoMinimizeDuration;this.playlist.classList.add("funshow-playlist-minimized")}}}if(!this.isPlaying)return;this.remainingSlideTime-=dt*1e3;if(this.remainingSlideTime<=0){if(this.funShow.stage.currentIndex<this.funShow.stage.slides.length-1||this.isShuffle||this.loop){if(this.isShuffle){this.funShow.stage.jumpToRandomSlide(false)}else{this.funShow.stage.changeSlide(1)}this.remainingSlideTime=Infinity;this.updateProgressBar()}else{this.pauseSlideshow()}}else if(this.isPlaying){this.updateProgressBar()}}updateProgressBar(){const progress=(this.slideDuration-this.remainingSlideTime)/this.slideDuration*100;if(progress>0){this.progressBar.style.width=`${progress}%`}else{this.progressBar.style.width=`0%`}}updateTitle(){const currentIndex=this.getCurrentSlideIndex()+1;const totalSlides=this.funShow.stage.slides.filter((slide=>slide.item.type!=="category")).length;const currentSection=this.getCurrentSection();const totalSections=this.funShow.stage.slides.filter((slide=>slide.item.type==="category")).length;this.sectionCount.textContent=totalSections>0?`SECTION (${currentSection}/${totalSections})`:"";this.slideCount.textContent=`SLIDE (${currentIndex}/${totalSlides})`;const sectionTitle=this.funShow.stage.slides.find(((slide,index)=>index===this.getCurrentSectionIndex()&&slide.item.type==="category"))?.item.title||"";const slideTitle=this.funShow.stage.slides[this.funShow.stage.currentIndex]?.item.title||"";this.sectionInfo.textContent=sectionTitle;this.slideInfo.textContent=slideTitle;this.collapsedInfo.innerHTML=`\n            <div>${sectionTitle}</div>\n            <div>${slideTitle}</div>\n        `;this.currentSectionInfo.textContent=sectionTitle;this.currentSlideInfo.textContent=slideTitle}getCurrentSlideIndex(){const currentIndex=this.funShow.stage.currentIndex;let slideCount=0;for(let i=0;i<=currentIndex;i++){if(this.funShow.stage.slides[i].item.type!=="category"){slideCount++}}return slideCount-1}getCurrentSection(){const currentIndex=this.funShow.stage.currentIndex;for(let i=currentIndex;i>=0;i--){if(this.funShow.stage.slides[i].item.type==="category"){//!this.funShow.stage.slides[i].item.file) {
return this.funShow.stage.slides.slice(0,i+1).filter((slide=>slide.item.type==="category")).length}}return 1}getCurrentSectionIndex(){const currentIndex=this.funShow.stage.currentIndex;for(let i=currentIndex;i>=0;i--){if(this.funShow.stage.slides[i].item.type==="category"){return i}}return-1}userInteraction(){if(this.autoMinimize){this.elaspedSinceLastInteraction=0;if(this.playlist.classList.contains("funshow-playlist-minimized")){this.playlist.classList.remove("funshow-playlist-minimized");const currentIndex=Number(this.slidesContainer.querySelector(".funshow-playlist-slide-active").getAttribute("data-index"));this.adjustScrollPosition(currentIndex);this.updateStickySection()}}}onSlideArriving(){if(this.isPlaying&&this.slideDuration-this.remainingSlideTime<=0){this.resetRemainingSlideTime()}}updateActiveItem({previousIndex:previousIndex,currentIndex:currentIndex,direction:direction,wasUserAction:wasUserAction}){const currentSlide=this.funShow.stage.slides[currentIndex];this.slideDuration=currentSlide?.item?.config?.hasOwnProperty("displayDuration")?currentSlide.item.config.displayDuration*1e3:this.funShow.slideshow.config.slideDisplayDuration*1e3;const items=this.slidesContainer.querySelectorAll(".funshow-playlist-slide");items.forEach((item=>{item.classList.toggle("funshow-playlist-slide-active",item.dataset.index==currentIndex)}));this.updateTitle();this.adjustScrollPosition(currentIndex);this.updateStickySection(currentIndex);if(wasUserAction){this.userInteraction();if(this.isPlaying&&this.pauseOnInteraction){this.pauseSlideshow()}}else if(this.autoMinimize&&this.alwaysShowOnSlideChange){this.userInteraction()}if(this.isPlaying){this.startSlideshow()}}adjustScrollPosition(currentIndex){const activeItem=this.slidesContainer.querySelector(".funshow-playlist-slide-active");if(activeItem){const containerRect=this.slidesContainer.getBoundingClientRect();const itemRect=activeItem.getBoundingClientRect();const stickyElement=this.slidesContainer.querySelector(".sticky-section");const stickyHeight=stickyElement?stickyElement.getBoundingClientRect().height:0;const adjustedTop=containerRect.top+stickyHeight;if(itemRect.top<adjustedTop){this.slidesContainer.scrollTop-=adjustedTop-itemRect.top}else if(itemRect.bottom>containerRect.bottom){this.slidesContainer.scrollTop+=itemRect.bottom-containerRect.bottom}}}updateStickySection(currentIndex){const sections=this.slidesContainer.querySelectorAll(".funshow-playlist-slide.section");sections.forEach((section=>section.classList.remove("sticky-section")));const currentSectionIndex=this.getCurrentSectionIndex();if(currentSectionIndex!==-1){const currentSection=this.slidesContainer.querySelector(`.funshow-playlist-slide[data-index="${currentSectionIndex}"]`);if(currentSection){currentSection.classList.add("sticky-section")}}}toggleCollapsedState(){this.isCollapsed=!this.isCollapsed;this.playlist.classList.toggle("funshow-playlist-collapsed",this.isCollapsed);this.updateTitle();if(!this.isCollapsed){const currentIndex=Number(this.slidesContainer.querySelector(".funshow-playlist-slide-active").getAttribute("data-index"));this.adjustScrollPosition(currentIndex);this.updateStickySection()}}toggleShuffleState(){this.isShuffle=!this.isShuffle;this.playlist.classList.toggle("funshow-playlist-shuffle",this.isShuffle)}onPrevClick(){if(this.isShuffle){this.funShow.stage.jumpToRandomSlide(true)}else{this.funShow.stage.changeSlide(-1,true)}}onPlayClick(){this.isPlaying=true;this.startSlideshow();this.resetRemainingSlideTime()}onPauseClick(){this.isPlaying=false;this.pauseSlideshow()}onNextClick(){if(this.isShuffle){this.funShow.stage.jumpToRandomSlide(true)}else{this.funShow.stage.changeSlide(1,true)}}}class FunShowStagePanelToolbar extends FunShowEventEmitter{constructor(funShow){super();this.funShow=funShow;this.container=null;this.injectCSS();this.funShow.on("initialize",this.initHTML.bind(this))}destroy(){this.emit("destroy");this.funShow.off("initialize",this.initHTML);if(this.stopButton){this.stopButton.removeEventListener("click",this.onStopClick)}if(this.editButton){this.editButton.removeEventListener("click",this.onEditClick)}const styleElement=document.head.querySelector("style[data-funshow-toolbar-style]");if(styleElement){document.head.removeChild(styleElement)}if(this.container&&this.container.parentNode){this.container.parentNode.removeChild(this.container)}this.funShow=null;this.container=null;this.stopButton=null;this.editButton=null;this.off()}injectCSS(){const style=document.createElement("style");style.setAttribute("data-funshow-toolbar-style","");const css=`\n            .funshow-toolbar {\n                position: fixed;\n                bottom: 20px;\n                left: 20px;\n                background: var(--primary-bgcolor-highopacity);\n                color: var(--primary-color);\n                padding: 2px;\n                border-radius: 5px;\n                font-family: var(--primary-font-family);\n                font-size: 14px;\n                z-index: 10;\n                display: flex;\n                gap: 10px;\n            }\n            .funshow-toolbar-button {\n                background: none;\n                border: none;\n                cursor: pointer;\n                padding: 5px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .funshow-toolbar-button svg {\n                width: 24px;\n                height: 24px;\n                fill: var(--primary-color);\n            }\n            .funshow-toolbar-button:hover svg {\n                fill: var(--primary-color-highlight);\n            }\n            .funshow-edit-button svg {\n                fill: var(--primary-color);\n                stroke: var(--primary-color);\n            }\n        `;style.textContent=css;document.head.appendChild(style)}initHTML(){const toolbarHTML=`\n            <div class="funshow-toolbar">\n                <button class="funshow-toolbar-button funshow-stop-button" title="Stop">\n                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 3 24 19">\n                        <path d="M12 5L4 19h16L12 5zm0 3.865L16.865 17H7.135L12 8.865z"/>\n                        <rect x="4" y="20" width="16" height="2"/>\n                    </svg>\n                </button>\n                <button class="funshow-toolbar-button funshow-edit-button" title="Edit">\n                    <svg viewBox="19 19 33 25" xmlns="http://www.w3.org/2000/svg" class="funshow-toolbar-icon-builder">\n                        <g fill="currentColor">\n                            <rect x="22" y="22" width="20" height="20" style="fill: var(--primary-color);"/>\n                            <path d="M26 26h12M26 32h12M26 38h12" stroke-width="1" fill="none" style="stroke: var(--primary-color);"/>\n                            <path d="M26 26h12M26 32h12M26 38h12" stroke-width="1" style="stroke: var(--primary-bgcolor);"/>\n                            <path d="M46 22v20M50 26v12" stroke-width="2" fill="none" style="stroke: var(--primary-color);"/>\n                            <circle cx="46" cy="22" r="2" style="fill: var(--primary-color);"/>\n                            <circle cx="46" cy="42" r="2" style="fill: var(--primary-color);"/>\n                            <circle cx="50" cy="26" r="2" style="fill: var(--primary-color);"/>\n                            <circle cx="50" cy="38" r="2" style="fill: var(--primary-color);"/>\n                        </g>\n                    </svg>\n                </button>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",toolbarHTML);this.container=document.querySelector(".funshow-toolbar");this.stopButton=this.container.querySelector(".funshow-stop-button");this.editButton=this.container.querySelector(".funshow-edit-button");this.stopButton.addEventListener("click",this.onStopClick.bind(this));this.editButton.addEventListener("click",this.onEditClick.bind(this));if(!window.funShowEnvironment.modules.FunShowBuilder){this.editButton.style.display="none"}}onStopClick(){this.funShow.destroy();window.funShowEnvironment.startBlankViewer()}onEditClick(){const slideshow=this.funShow.slideshow;this.funShow.destroy();slideshow.slides=slideshow.items;delete slideshow.items;new FunShowBuilder(null,slideshow)}}class FunShowHelpInput extends FunShowEventEmitter{constructor(isTouch=false,force=false){super();this.isTouch=isTouch;this.inputType=isTouch?"touch":"mouse";if(!force&&this.isTutorialCompleted()){this.destroy();return}this.container=document.createElement("div");document.body.appendChild(this.container);this.injectCSS();this.injectHTML();this.bindEvents();this.currentStep=0;this.steps=["pan","zoom","rotate"];this.helpSchema={mouse:{pan:{label:"PAN",content:"Left-click & move the mouse."},zoom:{label:"ZOOM",content:"Middle-mouse & move up/down to zoom."},rotate:{label:"ROTATE",content:"Right-mouse & move to rotate."}},touch:{pan:{label:"PAN",content:"Two finger drag to pan."},zoom:{label:"ZOOM",content:"Pinch with two fingers to zoom."},rotate:{label:"ROTATE",content:"One finger to rotate."}}};this.start()}isTutorialCompleted(){const inputHelpDone=JSON.parse(localStorage.getItem("inputHelpDone")||"{}");return inputHelpDone[this.inputType]===true}markTutorialAsCompleted(){const inputHelpDone=JSON.parse(localStorage.getItem("inputHelpDone")||"{}");inputHelpDone[this.inputType]=true;localStorage.setItem("inputHelpDone",JSON.stringify(inputHelpDone))}destroy(){this.emit("destroy");const styleElement=document.head.querySelector("style[data-funshow-helpinput-style]");if(styleElement){document.head.removeChild(styleElement)}if(this.container){this.container.remove()}this.off();this.container=null;this.markTutorialAsCompleted()}injectCSS(){const style=document.createElement("style");style.setAttribute("data-funshow-helpinput-style","");style.textContent=`\n            ${this.getExistingStyles()}\n            .funshow-help-input-container {\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%) scale(0.9);\n                background-color: rgba(0, 0, 0, 0.8);\n                border-radius: 10px;\n                padding: 20px;\n                text-align: center;\n                font-family: Arial, sans-serif;\n                color: white;\n                z-index: 1000;\n                opacity: 0;\n                transition: all 0.3s ease-in-out;\n            }\n            .funshow-help-input-container.active {\n                transform: translate(-50%, -50%) scale(1);\n                opacity: 1;\n            }\n            .funshow-help-input-container.fade-out {\n                transform: translate(-50%, -50%) scale(0.9);\n                opacity: 0;\n            }\n            .funshow-help-input-buttons {\n                display: flex;\n                justify-content: center;\n                gap: 20px;\n                margin-top: 20px;\n            }\n            .funshow-help-input-button {\n                background-color: #4169E1;\n                color: white;\n                border: none;\n                padding: 10px 20px;\n                border-radius: 5px;\n                cursor: pointer;\n                font-size: 16px;\n                transition: background-color 0.3s ease;\n            }\n            .funshow-help-input-button:hover {\n                background-color: #3154b3;\n            }\n            .funshow-help-input-info-label {\n                padding: 12px;\n                font-size: 20px;\n            }\n        `;document.head.appendChild(style)}getExistingStyles(){return`\n            .funshow-help-input-panel {\n                display: flex;\n                flex-direction: column;\n            }\n            .funshow-help-input-mouse-icon,\n            .funshow-help-input-touch-icon {\n                padding: 16px;\n                display: none;\n            }\n            .funshow-help-input-panel-mode-mouse .funshow-help-input-mouse-icon {\n                display: block;\n            }\n            .funshow-help-input-panel-mode-touch .funshow-help-input-touch-icon {\n                display: block;\n            }\n\n            .funshow-help-input-touch-icon {\n                padding: 16px;\n                display: none;\n            }\n\n            .funshow-help-input-panel-mode-touch .funshow-help-input-touch-icon {\n                display: block;\n            }\n\n            @keyframes funshow-help-input-clickLeftButton {\n                0%, 100% { fill: #f5f5f5; }\n                10%, 90% { fill: #4169E1; }\n            }\n            @keyframes funshow-help-input-clickRightButton {\n                0%, 100% { fill: #f5f5f5; }\n                10%, 90% { fill: #4169E1; }\n            }\n            @keyframes funshow-help-input-clickMouseWheel {\n                0%, 100% { fill: #c0c0c0; }\n                10%, 90% { fill: #4169E1; }\n            }\n            @keyframes funshow-help-input-moveMouse {\n                0%, 100% { transform: translate(0, 0); }\n                20% { transform: translate(-10px, 0); }\n                40% { transform: translate(10px, 0); }\n                60% { transform: translate(0, -10px); }\n                80% { transform: translate(0, 10px); }\n            }\n            @keyframes funshow-help-input-zoomMouse {\n                0%, 100% { transform: translate(0, 0); }\n                33% { transform: translate(0, -10px); }\n                66% { transform: translate(0, 10px); }\n            }\n            .funshow-help-input-mouse-pan .funshow-help-input-mouse-left-button {\n                animation: funshow-help-input-clickLeftButton 4s ease-in-out infinite;\n            }\n            .funshow-help-input-mouse-pan .funshow-help-input-mouse {\n                animation: funshow-help-input-moveMouse 4s ease-in-out infinite;\n            }\n            .funshow-help-input-mouse-rotate .funshow-help-input-mouse-right-button {\n                animation: funshow-help-input-clickRightButton 4s ease-in-out infinite;\n            }\n            .funshow-help-input-mouse-rotate .funshow-help-input-mouse {\n                animation: funshow-help-input-moveMouse 4s ease-in-out infinite;\n            }\n            .funshow-help-input-mouse-zoom .funshow-help-input-mouse-wheel {\n                animation: funshow-help-input-clickMouseWheel 4s ease-in-out infinite;\n            }\n            .funshow-help-input-mouse-zoom .funshow-help-input-mouse {\n                animation: funshow-help-input-zoomMouse 4s ease-in-out infinite;\n            }\n\n\n\n            .funshow-help-input-touch-point {\n                opacity: 0;\n                transition: opacity 0.3s ease-in-out;\n            }\n\n            @keyframes funshow-help-input-touchMove {\n                0%, 100% { transform: translate(0, 0); }\n                25% { transform: translate(-10px, -10px); }\n                50% { transform: translate(10px, 10px); }\n                75% { transform: translate(10px, -10px); }\n            }\n\n            @keyframes funshow-help-input-touchPointFade {\n                0%, 100% { opacity: 0; }\n                10%, 90% { opacity: 1; }\n            }\n\n            /* Rotate animation */\n            .funshow-help-input-touch-rotate .funshow-help-input-touch {\n                animation: funshow-help-input-touchMove 4s ease-in-out infinite;\n            }\n\n            .funshow-help-input-touch-rotate .funshow-help-input-touch-point:first-child {\n                animation: funshow-help-input-touchPointFade 4s ease-in-out infinite;\n            }\n\n            .funshow-help-input-touch-rotate .funshow-help-input-touch-point:first-child {\n                opacity: 1;\n            }\n\n            /* Pan animation */\n            .funshow-help-input-touch-pan .funshow-help-input-touch {\n                animation: funshow-help-input-touchMove 4s ease-in-out infinite;\n            }\n\n            .funshow-help-input-touch-pan .funshow-help-input-touch-point {\n                animation: funshow-help-input-touchPointFade 4s ease-in-out infinite;\n            }\n\n            /* Updated arrow styling and animations */\n            .funshow-help-input-touch-rotated-group {\n                transform: rotate(12deg);\n                transform-origin: center;\n            }\n\n            @keyframes funshow-help-input-touch-zoomInArrows {\n                0%, 45%, 100% { opacity: 0; }\n                5%, 40% { opacity: 1; }\n            }\n\n            @keyframes funshow-help-input-touch-zoomOutArrows {\n                0%, 55%, 100% { opacity: 0; }\n                60%, 95% { opacity: 1; }\n            }\n\n            @keyframes funshow-help-input-touch-zoomInTop {\n                0%, 100% { transform: translateY(0); }\n                50% { transform: translateY(10px); }\n            }\n\n            @keyframes funshow-help-input-touch-zoomInBottom {\n                0%, 100% { transform: translateY(0); }\n                50% { transform: translateY(-10px); }\n            }\n\n            @keyframes funshow-help-input-touch-zoomOutTop {\n                0%, 100% { transform: translateY(0); }\n                50% { transform: translateY(-10px); }\n            }\n\n            @keyframes funshow-help-input-touch-zoomOutBottom {\n                0%, 100% { transform: translateY(0); }\n                50% { transform: translateY(10px); }\n            }\n\n            .funshow-help-input-touch-rotated-group path {\n                stroke: #ffffff;\n                opacity: 0;\n            }\n\n            @keyframes funshow-help-input-touch-zoomPointFade {\n                0%, 100% { opacity: 0; }\n                10%, 90% { opacity: 1; }\n            }\n\n            .funshow-help-input-touch-zoom .funshow-help-input-touch-point {\n                animation: funshow-help-input-touch-zoomPointFade 4s ease-in-out infinite;\n            }\n\n            .funshow-help-input-touch-zoom .funshow-help-input-touch-zoom-in-top,\n            .funshow-help-input-touch-zoom .funshow-help-input-touch-zoom-in-bottom {\n                animation: funshow-help-input-touch-zoomInArrows 8s ease-in-out infinite,\n                           funshow-help-input-touch-zoomInTop 1.2s ease-in-out infinite;\n            }\n\n            .funshow-help-input-touch-zoom .funshow-help-input-touch-zoom-in-bottom {\n                animation: funshow-help-input-touch-zoomInArrows 8s ease-in-out infinite,\n                           funshow-help-input-touch-zoomInBottom 1.2s ease-in-out infinite;\n            }\n\n            .funshow-help-input-touch-zoom .funshow-help-input-touch-zoom-out-top,\n            .funshow-help-input-touch-zoom .funshow-help-input-touch-zoom-out-bottom {\n                animation: funshow-help-input-touch-zoomOutArrows 8s ease-in-out infinite,\n                           funshow-help-input-touch-zoomOutTop 1.2s ease-in-out infinite;\n            }\n\n            .funshow-help-input-touch-zoom .funshow-help-input-touch-zoom-out-bottom {\n                animation: funshow-help-input-touch-zoomOutArrows 8s ease-in-out infinite,\n                           funshow-help-input-touch-zoomOutBottom 1.2s ease-in-out infinite;\n            }\n        `}injectHTML(){this.container.innerHTML=`\n            <div class="funshow-help-input-container">\n                <div class="funshow-help-input-panel">\n                    <div class="funshow-help-input-mouse-icon">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="160" viewBox="-4 -4 108 168">\n                            <defs>\n                                <linearGradient id="mouseGradient" x1="0%" y1="0%" x2="100%" y2="100%">\n                                    <stop offset="0%" style="stop-color:#999999;stop-opacity:1" />\n                                    <stop offset="100%" style="stop-color:#ffffff;stop-opacity:1" />\n                                </linearGradient>\n                            </defs>\n                            <g class="funshow-help-input-mouse">\n                                <path d="M10 40 Q10 10 50 10 Q90 10 90 40 V120 Q90 150 50 150 Q10 150 10 120 Z" fill="url(#mouseGradient)" stroke="#000000" stroke-width="0"/>\n                                <path class="funshow-help-input-mouse-left-button" d="M10 40 Q10 10 50 10 V70 H10 Z" fill="#f5f5f5" stroke="#000000" stroke-width="0"/>\n                                <path class="funshow-help-input-mouse-right-button" d="M50 10 Q90 10 90 40 V70 H50 Z" fill="#f5f5f5" stroke="#000000" stroke-width="0"/>\n                                <rect class="funshow-help-input-mouse-wheel" x="45" y="20" width="10" height="30" fill="#c0c0c0" stroke="#000000" stroke-width="0"/>\n                            </g>\n                        </svg>\n                    </div>\n                    <div class="funshow-help-input-touch-icon">\n                        <svg width="100" height="100" viewBox="-14 -24 128 165" xmlns="http://www.w3.org/2000/svg">\n                            <defs>\n                                <marker id="funshow-help-input-touch-arrowhead" refX="1" refY="26.2" orient="auto" viewBox="0 0 56.53 51.39" markerUnits="userSpaceOnUse" markerWidth="19.88" markerHeight="18.07">\n                                    <path d="m 57.03 26.2l -51.39 -25.7 0 20.02 -5.14 0.01 0 11.38 5.14 -0.03 0 20.02 51.39 -25.7 z" style="fill:#ffffff;stroke:none"/>\n                                </marker>\n                            </defs>\n                            <g class="funshow-help-input-touch">\n                                \x3c!-- Primary touch point circle --\x3e\n                                <circle class="funshow-help-input-touch-point" cx="25" cy="7" r="16" stroke="#4169E1" fill="#4169E1" stroke-width="4" />\n                                \x3c!-- Secondary touch point circle --\x3e\n                                <circle class="funshow-help-input-touch-point" cx="10" cy="80" r="16" stroke="#4169E1" fill="#4169E1" stroke-width="4" />\n                                \x3c!-- Original finger path --\x3e\n                                <path d="m27.17 0.89c4.1-0.39 7.12 2.54 8.77 5.85 2 4 3.13 8.49 4.97 12.57 2.43 5.41 4.82 10.87 7.02 16.37 0.16-1.56 0.3-4.28 1.17-5.55 2.72-3.95 8.26-5.89 12.28-2.92 3.08 2.27 3.77 6.07 5.26 9.06 0.34-1.72 0.37-4.17 1.46-5.55 2.69-3.43 7.97-4.94 11.7-2.05 2.86 2.22 3.52 6.15 4.97 9.06 0.13-1.35-0.02-3.92 0.88-5.26 3.1-4.65 9.37-6.08 13.45-1.46 1.23 1.4 1.71 3.58 2.34 5.26 1.42 3.78 3.02 7.72 4.68 11.4 2.64 5.86 4.68 11.98 7.31 17.83 1.39 3.08 2.99 6.21 3.51 9.65 1.66 11.06 0.18 23.39 2.34 34.21-15.18 6.07-30.15 12.64-45.33 18.71-4.95-2.47-9.59-5.63-14.62-7.89-6.61-2.98-13.19-5.37-19.3-9.65-6.7-4.69-12.67-11.28-19.01-16.66-1.05-0.89-1.84-1.8-2.92-2.63-0.91-0.7-2.37-1.27-3.22-2.05-3.64-3.36-9.7-9.36-4.39-13.74 2.95-2.43 9.22-1.59 12.58-0.58 3.94 1.18 6.92 3.57 10.53 5.55 5.32 2.93 11.35 5.84 17.25 6.43-4.31-10.77-8.69-21.58-13.45-32.16-5.02-11.15-9.02-22.76-14.04-33.91-2.06-4.58-5.16-10.29-2.92-15.49 0.64-1.5 2.4-2.36 3.51-3.22 0.78-0.6 2.26-1.08 3.22-1.17z" fill="#ffffff" fill-rule="evenodd"/>\n                            </g>\n                            <g class="funshow-help-input-touch-rotated-group">\n                                <path class="funshow-help-input-touch-zoom-in-top" d="m -22 30 l 0 -9.74" style="fill:none;stroke-width:4;stroke-miterlimit:100;marker-end:url(#funshow-help-input-touch-arrowhead)"/>\n                                <path class="funshow-help-input-touch-zoom-in-bottom" d="m -22 80 l 0 9.74" style="fill:none;stroke-width:4;stroke-miterlimit:100;marker-end:url(#funshow-help-input-touch-arrowhead)"/>\n                                <path class="funshow-help-input-touch-zoom-out-top" d="m -22 20 l 0 9.74" style="fill:none;stroke-width:4;stroke-miterlimit:100;marker-end:url(#funshow-help-input-touch-arrowhead)"/>\n                                <path class="funshow-help-input-touch-zoom-out-bottom" d="m -22 90 l 0 -9.74" style="fill:none;stroke-width:4;stroke-miterlimit:100;marker-end:url(#funshow-help-input-touch-arrowhead)"/>\n                            </g>\n                        </svg>\n                    </div>\n                    <div class="funshow-help-input-info">\n                        <div class="funshow-help-input-info-label"></div>\n                        <div class="funshow-help-input-info-content"></div>\n                    </div>\n                </div>\n                <div class="funshow-help-input-buttons">\n                    <button class="funshow-help-input-button" id="funshow-help-input-skip">Skip</button>\n                    <button class="funshow-help-input-button" id="funshow-help-input-next">Next</button>\n                </div>\n            </div>\n        `}bindEvents(){this.skipButtonHandler=this.skip.bind(this);this.nextButtonHandler=this.nextStep.bind(this);this.container.querySelector("#funshow-help-input-skip").addEventListener("click",this.skipButtonHandler);this.container.querySelector("#funshow-help-input-next").addEventListener("click",this.nextButtonHandler)}showInputHelp(inputType,inputKey){const container=this.container.querySelector(".funshow-help-input-container");const panel=this.container.querySelector(".funshow-help-input-panel");const infoLabel=this.container.querySelector(".funshow-help-input-info-label");const infoContent=this.container.querySelector(".funshow-help-input-info-content");const mouseIcon=this.container.querySelector(".funshow-help-input-mouse-icon");const touchIcon=this.container.querySelector(".funshow-help-input-touch-icon");const skipButton=this.container.querySelector("#funshow-help-input-skip");const nextButton=this.container.querySelector("#funshow-help-input-next");container.classList.add("fade-out");setTimeout((()=>{panel.className="funshow-help-input-panel";infoLabel.textContent="";infoContent.textContent="";mouseIcon.classList.remove("funshow-help-input-mouse-pan","funshow-help-input-mouse-zoom","funshow-help-input-mouse-rotate");touchIcon.classList.remove("funshow-help-input-touch-pan","funshow-help-input-touch-zoom","funshow-help-input-touch-rotate");if(!inputType||!inputKey)return;panel.offsetWidth;panel.classList.add(`funshow-help-input-panel-mode-${inputType}`);const helpInfo=this.helpSchema[inputType][inputKey];infoLabel.textContent=helpInfo.label;infoContent.textContent=helpInfo.content;if(inputType==="mouse"){mouseIcon.classList.add(`funshow-help-input-mouse-${inputKey}`)}else if(inputType==="touch"){touchIcon.classList.add(`funshow-help-input-touch-${inputKey}`)}if(this.currentStep===this.steps.length-1){skipButton.style.display="none";nextButton.textContent="Let's go!"}else{skipButton.style.display="inline-block";nextButton.textContent="Next"}container.classList.remove("fade-out");container.classList.add("active")}),300)}skip(){const container=this.container.querySelector(".funshow-help-input-container");container.classList.add("fade-out");setTimeout((()=>{this.destroy()}),300)}nextStep(){this.currentStep++;if(this.currentStep>=this.steps.length){this.skip()}else{this.showCurrentStep()}}start(){this.currentStep=0;this.showCurrentStep();setTimeout((()=>{const container=this.container.querySelector(".funshow-help-input-container");container.classList.add("active")}),0)}prevStep(){this.currentStep=(this.currentStep-1+this.steps.length)%this.steps.length;this.showCurrentStep()}showCurrentStep(){const inputType=this.isTouch?"touch":"mouse";this.showInputHelp(inputType,this.steps[this.currentStep])}showCurrentStep(){const inputType=this.isTouch?"touch":"mouse";this.showInputHelp(inputType,this.steps[this.currentStep])}}class FunShowZoomPan{constructor(containerElement,targetElement,startingScale,options={}){this.container=containerElement;this.target=targetElement;this.startingScale=startingScale;this.scale=this.startingScale;this.lastScale=this.startingScale;this.startX=0;this.startY=0;this.panX=0;this.panY=0;this.initialDistance=null;this.lastPanX=0;this.lastPanY=0;this.rotation=0;this.rotationX=0;this.rotationY=0;this.perspectiveOriginX=50;this.perspectiveOriginY=50;this.maxSkewAngle=30;this.isMobile=window.funShowEnvironment.isMobile;this.panButton=options.panButton??0;this.rotateButton=options.rotateButton??2;this.zoomButton=options.zoomButton??1;this.use3D=options.use3D??1;this.activeButton=null;this.touchCount=0;this.lastTouchRotation=0;this.updatePerspective=this.updatePerspective.bind(this);window.addEventListener("resize",this.updatePerspective);this.setupStyles();this.addEventListeners();this.updateTransform();this.updatePerspective()}setupStyles(){this.target.style.transformOrigin="center center"}addEventListeners(){this.onWheelBound=this.onWheel.bind(this);this.onTouchStartBound=this.onTouchStart.bind(this);this.onTouchMoveBound=this.onTouchMove.bind(this);this.onTouchEndBound=this.onTouchEnd.bind(this);if(!this.isMobile){this.onPointerDownBound=this.onPointerDown.bind(this);this.onPointerMoveBound=this.onPointerMove.bind(this);this.onPointerUpBound=this.onPointerUp.bind(this);this.onPointerCancelBound=this.onPointerCancel.bind(this);this.onContextMenuBound=this.onContextMenu.bind(this)}this.container.addEventListener("wheel",this.onWheelBound);this.container.addEventListener("touchstart",this.onTouchStartBound);this.container.addEventListener("touchmove",this.onTouchMoveBound);this.container.addEventListener("touchend",this.onTouchEndBound);if(!this.isMobile){this.container.addEventListener("pointerdown",this.onPointerDownBound);this.container.addEventListener("pointermove",this.onPointerMoveBound);this.container.addEventListener("pointerup",this.onPointerUpBound);this.container.addEventListener("pointercancel",this.onPointerCancelBound);document.addEventListener("contextmenu",this.onContextMenuBound)}}destroy(){this.container.removeEventListener("wheel",this.onWheelBound);this.container.removeEventListener("touchstart",this.onTouchStartBound);this.container.removeEventListener("touchmove",this.onTouchMoveBound);this.container.removeEventListener("touchend",this.onTouchEndBound);if(!this.isMobile){this.container.removeEventListener("pointerdown",this.onPointerDownBound);this.container.removeEventListener("pointermove",this.onPointerMoveBound);this.container.removeEventListener("pointerup",this.onPointerUpBound);this.container.removeEventListener("pointercancel",this.onPointerCancelBound);document.removeEventListener("contextmenu",this.onContextMenuBound)}this.scale=this.startingScale;this.lastScale=this.startingScale;this.startX=0;this.startY=0;this.panX=0;this.panY=0;this.initialDistance=null;this.lastPanX=0;this.lastPanY=0;this.rotation=0;this.activeButton=null;this.rotation=0;this.rotationX=0;this.rotationY=0;this.perspectiveOriginX=50;this.perspectiveOriginY=50;this.use3D=0;window.removeEventListener("resize",this.updatePerspective);if(this.container){this.container.style.perspective="";this.container.style.perspectiveOrigin=""}this.container=null;this.target=null}onPointerDown(e){e.preventDefault();this.startX=e.clientX;this.startY=e.clientY;this.activeButton=e.button;this.container.setPointerCapture(e.pointerId)}onPointerMove(e){if(this.activeButton===this.panButton){this.handlePan(e)}else if(this.activeButton===this.rotateButton){this.handleRotate(e)}else if(this.activeButton===this.zoomButton){this.handleZoom(e)}}handlePan(e){const moveX=(e.clientX-this.startX)/this.scale;const moveY=(e.clientY-this.startY)/this.scale;this.panX+=moveX;this.panY+=moveY;this.startX=e.clientX;this.startY=e.clientY;this.updateTransform()}handleRotate(e){const deltaX=(e.clientX-this.startX)*.5;const deltaY=(e.clientY-this.startY)*-.5;const sensitivity3D=.5;switch(this.use3D){case 0:this.rotation+=deltaY;break;case 1:this.rotationY+=deltaX*sensitivity3D;this.rotationX+=deltaY*sensitivity3D;break}this.updateTransform();this.startX=e.clientX;this.startY=e.clientY}handleZoom(e){const delta=(e.clientY-this.startY)*-.01;const newScale=this.scale+delta;this.setScaleWithCenter(newScale,e.clientX,e.clientY);this.updateTransform();this.startY=e.clientY}onPointerUp(e){this.container.releasePointerCapture(e.pointerId);this.activeButton=null;this.lastScale=this.scale}onPointerCancel(e){this.container.releasePointerCapture(e.pointerId);this.activeButton=null;this.lastScale=this.scale}updatePerspective(){const rect={width:window.innerWidth,height:window.innerHeight};const diagonal=Math.sqrt(rect.width*rect.width+rect.height*rect.height);this.perspective=diagonal*.75;this.container.style.perspective=`${this.perspective}px`}updateTransform(){let transform=`scale(${this.scale}) translate(${this.panX}px, ${this.panY}px)`;switch(this.use3D){case 0:transform+=` rotate(${this.rotation}deg)`;break;case 1:this.container.style.perspectiveOrigin=`${this.perspectiveOriginX}% ${this.perspectiveOriginY}%`;this.target.style.transformOrigin="center center";transform+=` rotateX(${this.rotationX}deg) rotateY(${this.rotationY}deg)`;break}this.target.style.transform=transform}onWheel(e){e.preventDefault();e.stopPropagation();const rect=this.container.getBoundingClientRect();const centerX=e.clientX;const centerY=e.clientY;const delta=Math.sign(e.deltaY)*-.1;const newScale=this.scale+delta;this.setScaleWithCenter(newScale,centerX,centerY);this.updateTransform()}onTouchMove(e){e.preventDefault();this.touchCount=e.touches.length;if(this.touchCount===1){this.handleOneFingerTouch(e.touches[0])}else if(this.touchCount===2){this.handleTwoFingerTouch(e.touches[0],e.touches[1])}}handleOneFingerTouch(touch){const deltaX=touch.pageX-this.startX;const deltaY=touch.pageY-this.startY;const sensitivity=.5;this.rotationY+=deltaX*sensitivity;this.rotationX-=deltaY*sensitivity;this.startX=touch.pageX;this.startY=touch.pageY;this.updateTransform()}handleTwoFingerTouch(touch1,touch2){const currentDistance=Math.hypot(touch2.pageX-touch1.pageX,touch2.pageY-touch1.pageY);const centerX=(touch1.pageX+touch2.pageX)/2;const centerY=(touch1.pageY+touch2.pageY)/2;if(this.initialDistance===null){this.initialDistance=currentDistance;this.lastCenterX=centerX;this.lastCenterY=centerY}else{const newScale=currentDistance/this.initialDistance*this.lastScale;this.setScaleWithCenter(newScale,centerX,centerY);const movementX=centerX-this.lastCenterX;const movementY=centerY-this.lastCenterY;this.panX+=movementX/this.scale;this.panY+=movementY/this.scale;this.lastCenterX=centerX;this.lastCenterY=centerY}this.updateTransform()}onTouchEnd(e){this.touchCount=e.touches.length;if(this.touchCount<2){this.initialDistance=null;this.lastScale=this.scale}if(this.touchCount===0){this.startX=0;this.startY=0}else if(this.touchCount===1){this.startX=e.touches[0].pageX;this.startY=e.touches[0].pageY}}onTouchStart(e){this.touchCount=e.touches.length;if(this.touchCount===1){this.startX=e.touches[0].pageX;this.startY=e.touches[0].pageY}else if(this.touchCount===2){this.initialDistance=null}}setScaleWithCenter(newScale,centerX,centerY){newScale=Math.min(Math.max(.25,newScale),3);if(newScale!==this.scale){const rect=this.container.getBoundingClientRect();const offsetX=centerX-rect.left-rect.width/2;const offsetY=centerY-rect.top-rect.height/2;const scaleRatio=newScale/this.scale;this.panX-=offsetX*(scaleRatio-1)/newScale;this.panY-=offsetY*(scaleRatio-1)/newScale;this.scale=newScale}}onContextMenu(e){e.preventDefault()}}